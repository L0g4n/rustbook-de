<!DOCTYPE HTML>
<html lang="de" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Nebenläufigkeit | Die Programmiersprache Rust</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.5.1">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-anchors/plugin.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../book/Syntax_Und_Semantik.html" />
    
    
    <link rel="prev" href="../book/Iteratoren.html" />
    

        
    </head>
    <body>
        
        
    <div class="book" data-level="3.6" data-chapter-title="Nebenläufigkeit" data-filepath="book/Nebenläufigkeit.md" data-basepath=".." data-revision="Mon Nov 02 2015 23:21:51 GMT+0100 (CET)">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Einführung
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="book/Erste_Schritte.html">
            
                
                    <a href="../book/Erste_Schritte.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Erste Schritte
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="book/Rust_Installieren.html">
            
                
                    <a href="../book/Rust_Installieren.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        Rust installieren
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="book/Hallo_Welt.html">
            
                
                    <a href="../book/Hallo_Welt.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        Hallo Welt
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="book/Hallo_Cargo.html">
            
                
                    <a href="../book/Hallo_Cargo.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                        Hallo Cargo
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="book/Lerne_Rust.html">
            
                
                    <a href="../book/Lerne_Rust.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Lerne Rust
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="book/Ratespiel.html">
            
                
                    <a href="../book/Ratespiel.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Ratespiel
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="book/Speisende_Philosophen.html">
            
            <span><b>2.2.</b> Speisende Philosophen</span>
            
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="book/Rust_In_Anderen_Sprachen.html">
            
            <span><b>2.3.</b> Rust in anderen Sprachen</span>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="book/Effektives_Rust.html">
            
                
                    <a href="../book/Effektives_Rust.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Effektives Rust
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="book/Der_Stack_Und_Der_Heap.html">
            
                
                    <a href="../book/Der_Stack_Und_Der_Heap.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        Der Stack und der Heap
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="book/Testen.html">
            
                
                    <a href="../book/Testen.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        Testen
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="book/Bedingte_Kompilierung.html">
            
                
                    <a href="../book/Bedingte_Kompilierung.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                        Bedingte Kompilierung
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="book/Dokumentation.html">
            
                
                    <a href="../book/Dokumentation.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.</b>
                        
                        Dokumentation
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="book/Iteratoren.html">
            
                
                    <a href="../book/Iteratoren.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.5.</b>
                        
                        Iteratoren
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="3.6" data-path="book/Nebenläufigkeit.html">
            
                
                    <a href="../book/Nebenläufigkeit.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.6.</b>
                        
                        Nebenläufigkeit
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.7" data-path="book/Fehlerbehandlung.html">
            
            <span><b>3.7.</b> Fehlerbehandlung</span>
            
            
        </li>
    
        <li class="chapter " data-level="3.8" data-path="book/Garantien_Wählen.html">
            
            <span><b>3.8.</b> Garantien Wählen</span>
            
            
        </li>
    
        <li class="chapter " data-level="3.9" data-path="book/FFI.html">
            
            <span><b>3.9.</b> FFI</span>
            
            
        </li>
    
        <li class="chapter " data-level="3.10" data-path="book/Borrow_Und_AsRef.html">
            
            <span><b>3.10.</b> Borrow und AsRef</span>
            
            
        </li>
    
        <li class="chapter " data-level="3.11" data-path="book/Release_Kanäle.html">
            
            <span><b>3.11.</b> Release Kanäle</span>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="book/Syntax_Und_Semantik.html">
            
                
                    <a href="../book/Syntax_Und_Semantik.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Syntax und Semantik
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1" data-path="book/Variablenbindung.html">
            
                
                    <a href="../book/Variablenbindung.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                        Variablenbindung
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="book/Funktionen.html">
            
                
                    <a href="../book/Funktionen.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.2.</b>
                        
                        Funktionen
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="book/Primitive_Typen.html">
            
                
                    <a href="../book/Primitive_Typen.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.3.</b>
                        
                        Primitive Typen
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="book/Kommentare.html">
            
                
                    <a href="../book/Kommentare.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.4.</b>
                        
                        Kommentare
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="book/If.html">
            
                
                    <a href="../book/If.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.5.</b>
                        
                        if
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.6" data-path="book/Schleifen.html">
            
                
                    <a href="../book/Schleifen.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.6.</b>
                        
                        Schleifen
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.7" data-path="book/Besitz.html">
            
                
                    <a href="../book/Besitz.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.7.</b>
                        
                        Besitz
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.8" data-path="book/Referenzen_Und_Ausleihen.html">
            
                
                    <a href="../book/Referenzen_Und_Ausleihen.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.8.</b>
                        
                        Referenzen und Ausleihen
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.9" data-path="book/Lebensdauer.html">
            
                
                    <a href="../book/Lebensdauer.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.9.</b>
                        
                        Lebensdauer
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.10" data-path="book/Veränderbarkeit.html">
            
            <span><b>4.10.</b> Veränderbarkeit</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.11" data-path="book/Structs.html">
            
                
                    <a href="../book/Structs.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.11.</b>
                        
                        Structs
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.12" data-path="book/Enums.html">
            
            <span><b>4.12.</b> Enums</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.13" data-path="book/Match.html">
            
            <span><b>4.13.</b> Match</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.14" data-path="book/Muster.html">
            
            <span><b>4.14.</b> Muster</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.15" data-path="book/Methodensyntax.html">
            
            <span><b>4.15.</b> Methodensyntax</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.16" data-path="book/Vektoren.html">
            
            <span><b>4.16.</b> Vektoren</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.17" data-path="book/Strings.html">
            
            <span><b>4.17.</b> Strings</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.18" data-path="book/Generics.html">
            
            <span><b>4.18.</b> Generics</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.19" data-path="book/Traits.html">
            
            <span><b>4.19.</b> Traits</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.20" data-path="book/Drop.html">
            
            <span><b>4.20.</b> Drop</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.21" data-path="book/If_Let.html">
            
            <span><b>4.21.</b> if let</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.22" data-path="book/Trait_Objekte.html">
            
            <span><b>4.22.</b> Trait Objekte</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.23" data-path="book/Closures.html">
            
            <span><b>4.23.</b> Closures</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.24" data-path="book/UFCS.html">
            
            <span><b>4.24.</b> Universal Function Call Syntax</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.25" data-path="book/Crates_Und_Module.html">
            
            <span><b>4.25.</b> Crates und Module</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.26" data-path="book/Const_Und_Static.html">
            
            <span><b>4.26.</b> `const` und `static`</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.27" data-path="book/Attribute.html">
            
            <span><b>4.27.</b> Attribute</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.28" data-path="book/Type_Aliase.html">
            
            <span><b>4.28.</b> `type` Aliase</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.29" data-path="book/Zwischen_Typen_Umwandeln.html">
            
            <span><b>4.29.</b> Zwischen typen umwandeln</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.30" data-path="book/Assoziierte_Typen.html">
            
            <span><b>4.30.</b> Assoziierte Typen</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.31" data-path="book/Größenlose_Typen.html">
            
            <span><b>4.31.</b> Größenlose Typen</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.32" data-path="book/Operatoren_Und_Überladen.html">
            
            <span><b>4.32.</b> Operatoren und Überladen</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.33" data-path="book/Deref_Umwandlung.html">
            
            <span><b>4.33.</b> Deref Umwandlung</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.34" data-path="book/Makros.html">
            
            <span><b>4.34.</b> Makros</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.35" data-path="book/Raw_Zeiger.html">
            
            <span><b>4.35.</b> Raw Zeiger</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.36" data-path="book/Unsafe.html">
            
            <span><b>4.36.</b> `unsafe`</span>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5" data-path="book/Nightly_Rust.html">
            
            <span><b>5.</b> Nightly Rust</span>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1" data-path="book/Compiler_Plugins.html">
            
            <span><b>5.1.</b> Compiler Plugins</span>
            
            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="book/Inline_Assembly.html">
            
            <span><b>5.2.</b> Inline Assembly</span>
            
            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="book/No_Stdlib.html">
            
            <span><b>5.3.</b> `no_stdlib`</span>
            
            
        </li>
    
        <li class="chapter " data-level="5.4" data-path="book/Intrinsics.html">
            
            <span><b>5.4.</b> Intrinsics</span>
            
            
        </li>
    
        <li class="chapter " data-level="5.5" data-path="book/Lang_Items.html">
            
            <span><b>5.5.</b> Lang items</span>
            
            
        </li>
    
        <li class="chapter " data-level="5.6" data-path="book/Fortgeschrittenes_Linken.html">
            
            <span><b>5.6.</b> Fortgeschrittenes Linken</span>
            
            
        </li>
    
        <li class="chapter " data-level="5.7" data-path="book/Benchmark_Tests.html">
            
            <span><b>5.7.</b> Benchmark Tests</span>
            
            
        </li>
    
        <li class="chapter " data-level="5.8" data-path="book/Box_Syntax_Und_Muster.html">
            
            <span><b>5.8.</b> Box Syntax und Muster</span>
            
            
        </li>
    
        <li class="chapter " data-level="5.9" data-path="book/Slice_Muster.html">
            
            <span><b>5.9.</b> Slice Muster</span>
            
            
        </li>
    
        <li class="chapter " data-level="5.10" data-path="book/Assoziierte_Konstanten.html">
            
            <span><b>5.10.</b> Assoziierte Konstanten</span>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="6" data-path="book/Glossar.html">
            
            <span><b>6.</b> Glossar</span>
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="book/Akademische_Forschung.html">
            
            <span><b>7.</b> Akademische Forschung</span>
            
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Veröffentlicht mit GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >Die Programmiersprache Rust</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="nebenl&#xE4;ufigkeit"><a name="nebenl&#xE4;ufigkeit" class="plugin-anchor" href="#nebenl&#xE4;ufigkeit"><span class="fa fa-link"></span></a>Nebenl&#xE4;ufigkeit</h1>
<p>Nebenl&#xE4;ufigkeit und Parallelismus sind heutzutage unglaublich wichtige Themen in der Informatik genauso wie in der Industrie.
Prozessoren haben mehr und mehr Kerne und dennoch sind Programmierer nicht gut darauf vorbereitet die vielen Kerne voll auszunutzen.</p>
<p>Rusts Speichersicherheit hat einen gro&#xDF;en Einflu&#xDF; auf dessen Verhalten bei Nebenl&#xE4;ufigkeit.
Das Typsystem garantiert bereits zur Kompilierzeit dass keine Speicherveletzungen oder Raceconditions auftreten k&#xF6;nnen.</p>
<p>Bevor wir auf Nebenl&#xE4;ufigkeit genauer eingehen ist eine Sache erw&#xE4;hnenswert:
Rust ist systemnah genug, dass ein Gro&#xDF;teil der hier genannten Funktionalit&#xE4;t von der Standardbibliothek zur Verf&#xFC;gung gestellt werden kann, nicht von der Sprache selbst.
Das hei&#xDF;t dass wenn man eine bestimmte Art und Weise wie Rust mit Nebenl&#xE4;ufigkeit umgeht nicht mag, dann kann man einfach eine Alternative implementieren.
<a href="https://github.com/carllerche/mio" target="_blank">mio</a> ist ein gutes Beispiel daf&#xFC;r.</p>
<h2 id="hintergrund-send-und-sync"><a name="hintergrund-send-und-sync" class="plugin-anchor" href="#hintergrund-send-und-sync"><span class="fa fa-link"></span></a>Hintergrund: <code>Send</code> und <code>Sync</code></h2>
<p>&#xDC;ber Verhalten bei Nebenl&#xE4;ufigkeit l&#xE4;sst sich h&#xE4;ufig nur schwer eine Aussage treffen.
In Rust haben wir jedoch ein strenges, statisches Typsystem, welches uns genau das erleichtert.
Zum Beispiel gibt uns Rust zwei Traits, die uns dabei helfen zu Entscheiden, ob Code potentiell Nebenl&#xE4;ufigkeit enthalten kann oder nicht.</p>
<h3 id="send"><a name="send" class="plugin-anchor" href="#send"><span class="fa fa-link"></span></a><code>Send</code></h3>
<p>Das erste Trait &#xFC;ber das wir reden ist <a href="http://doc.rust-lang.org/stable/std/marker/trait.Send.html" target="_blank"><code>Send</code></a>.
Wenn ein Typ <code>T</code> <code>Send</code> implementiert, dann hei&#xDF;t das, dass es m&#xF6;glich ist den Besitzer dieses Typs sicher zwischen zwei Threads zu wechseln.</p>
<p>Das ist wichtig um bestimmte Restriktionen durchzusetzen.
Wenn wir zum Beispiel einen <code>Channel</code> haben der zwei Threads verbindet, und gerne Daten durch diesen <code>Channel</code> zu einem anderen Thread senden m&#xF6;chten, dann m&#xFC;ssen wir sichergehen, dass der Datentyp den wir senden wollen auch <code>Send</code> implementiert.</p>
<p>Eine andere M&#xF6;glichkeit ist, wenn wir zum Beispiel eine FFI-Bibliothek anbinden, die nicht threadsicher ist, dann wollen wir explizit nicht <code>Send</code> implementieren, damit der Kompiler bereits verbietet, dass ein Objekt jemals den Thread wechselt.</p>
<h3 id="sync"><a name="sync" class="plugin-anchor" href="#sync"><span class="fa fa-link"></span></a><code>Sync</code></h3>
<p>Das zweite Trait hei&#xDF;t
<a href="http://doc.rust-lang.org/stable/std/marker/trait.Sync.html" target="_blank"><code>Sync</code></a>.
Wenn ein Typ <code>T</code> <code>Sync</code> implementiert, dann hei&#xDF;t das, dass es m&#xF6;glich ist diesen Typen sicher von zwei Threads aus &#xFC;ber mehrere Referenzen zu nutzen, ohne Speichersicherheit zu verletzen.
Das impliziert dass Typen die <em>keine</em> <a href="Mutabilit&#xE4;t.html">interne Mutabilit&#xE4;t</a> haben inh&#xE4;rent <code>Sync</code> sind, inklusive der primitiven Typen (wie <code>u8</code>) und daraus zusammengesetzte Typen.</p>
<p>Um Referenzen zwischen Threads zu teilen bietet einen Wrapper namens <code>Arc&lt;T&gt;</code>.
<code>Arc&lt;T&gt;</code> implementiert sowohl <code>Send</code> als auch <code>Sync</code> wenn,
und nur wenn, <code>T</code> ebenfalls sowohl <code>Send</code> als auch <code>Sync</code> implementiert.
So kann zum Beispiel ein Objekt vom Typ <code>Arc&lt;RefCell&lt;U&gt;&gt;</code> nicht von einem Thread zum anderen &#xFC;bertragen werden da
<a href="choosing-your-guarantees.html#refcell%3Ct%3E"><code>RefCell</code>
</a> nicht <code>Sync</code> implementiert, dementsprechend kann <code>Arc&lt;RefCell&lt;U&gt;&gt;</code> nicht <code>Send</code> implementieren.</p>
<h2 id="threads"><a name="threads" class="plugin-anchor" href="#threads"><span class="fa fa-link"></span></a>Threads</h2>
<p>Rusts Standardbibliothek enth&#xE4;lt auch eine Bibliothek f&#xFC;r Threads,
<code>std::thread</code>, die es dir erlaubt Code parallel auszuf&#xFC;hren.
Hier mal ein Beispiel:</p>
<pre><code class="lang-rust"><span class="hljs-keyword">use</span> std::thread;

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    thread::spawn(|| {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Hello from a thread!&quot;</span>);
    });
}
</code></pre>
<p>Die Methode <code>thread::spawn()</code> nimmt eine <a href="Closures.html">Closure</a> an,
die dann im neuen Thread ausgef&#xFC;hrt wird.
Der Handle den sie zur&#xFC;ck gibt,
kann benutzt werden um zu warten bis der Kind-Thread fertig ist und dessen Ergebnis zu erhalten:</p>
<pre><code class="lang-rust"><span class="hljs-keyword">use</span> std::thread;

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    <span class="hljs-keyword">let</span> handle = thread::spawn(|| {
        <span class="hljs-string">&quot;Hello from a thread!&quot;</span>
    });

    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;{}&quot;</span>, handle.join().unwrap());
}
</code></pre>
<p>Es bieten zwar viele Sprachen M&#xF6;glichkeiten an Threads zu starten,
das ist allerdings sehr unsicher.
Es gibt ganze B&#xFC;cher dar&#xFC;ber, wie man Fehler,
die dabei auftreten k&#xF6;nnen, wenn zwei Threads auf den gleichen Speicher zugreifen, verhindern kann.
Rust hilft hier mit seinem Typsystem, indem es Raceconditions bereits beim Kompilieren verhindert.
Wie teilt man also nun eigentlich Sachen zwischen Threads?</p>
<h2 id="sicherer-geteilter-und-ver&#xE4;nderbarer-speicher"><a name="sicherer-geteilter-und-ver&#xE4;nderbarer-speicher" class="plugin-anchor" href="#sicherer-geteilter-und-ver&#xE4;nderbarer-speicher"><span class="fa fa-link"></span></a>sicherer geteilter und ver&#xE4;nderbarer Speicher</h2>
<p>Rusts Typsystem biete ein Konzept an,
das zu gut klingt um wahr zu sein: &quot;Sicherer geteilter, ver&#xE4;nderbarer Speicher&quot;.
Unter Programmierern ist es allgemein bekannt, dass von mehreren Threads aus schreibbarer Speicher die Wurzel allen &#xDC;bels ist.</p>
<blockquote>
<p>Shared mutable state is the root of all evil. Most languages attempt to deal
with this problem through the &apos;mutable&apos; part, but Rust deals with it by
solving the &apos;shared&apos; part.</p>
</blockquote>
<p>Das gleiche <a href="Besitz.html">Besitz System</a> das uns dabei hilft Zeiger richtig zu benutzen hilft uns auch dabei Raceconditions zu vermeiden,
die schlimmste Art von Bugs bei Nebenl&#xE4;ufigkeit.</p>
<pre><code class="lang-ignore">use std::thread;

fn main() {
    let mut data = vec![1, 2, 3];

    for i in 0..3 {
        thread::spawn(move || {
            data[i] += 1;
        });
    }

    thread::sleep_ms(50);
}
</code></pre>
<p>f&#xFC;hrt zu diesem Fehler:</p>
<pre><code class="lang-text">8:17 error: capture of moved value: `data`
        data[i] += 1;
        ^~~~
</code></pre>
<p>Rust wei&#xDF; dass das nicht sicher w&#xE4;re.
Wenn wir eine Referenz auf <code>data</code> in jedem Thread haben,
dann m&#xFC;&#xDF;te auch jeder Thread Besitzer von <code>data</code> sein.
Das geht in Rust nicht.</p>
<p>Also brauchen wir einen Typen, der es uns erlaubt mehrere Referenzen auf einen Wert zu haben, die wir auf mehrere Threads verteilen k&#xF6;nnen.
Sprich, einen Typen der <code>Sync</code> implementiert.</p>
<p>Daf&#xFC;r benutzen wir <code>Arc&lt;T&gt;</code>, <em>Atomarer Referenz Count</em> (atomarer Referenzz&#xE4;hler).
<code>Arc&lt;T&gt;</code> ist &#xE4;hnlich wie <code>Box&lt;T&gt;</code>,
nur dass es erlaubt Zugriff auf seinen Inhalt von mehreren Referenzen aus zu haben.
Es k&#xF6;nnen sich quasi mehrere Threads den Besitz teilen.
Reference Counting bedeutet in diesem Zusammenhang,
dass gez&#xE4;hlt wird, wieviele Referenzen zu einem Wert existieren.
Atomar bedeutet, dass Raceconditions nicht m&#xF6;glich sind.</p>
<pre><code class="lang-ignorele">use std::thread;
use std::sync::Arc;

fn main() {
    let mut data = Arc::new(vec![1, 2, 3]);

    for i in 0..3 {
        let data = data.clone();
        thread::spawn(move || {
            data[i] += 1;
        });
    }

    thread::sleep_ms(50);
}
</code></pre>
<p>Wenn wir hier <code>clone()</code> auf unser <code>Arc&lt;T&gt;</code> aufrufen,
wird intern ein Counter inkrementiert und ein Handle an den Thread weitergegeben.</p>
<p>Und... immer noch ein Fehler:</p>
<pre><code class="lang-text"><anon>:11:24 error: cannot borrow immutable borrowed content as mutable
<anon>:11                    data[i] += 1;
                             ^~~~
</anon></anon></code></pre>
<p><code>Arc&lt;T&gt;</code> geht davon aus, dass sein Inhalt sicher geteilt werden kann, also auch <code>Sync</code> implementiert.
Das gilt f&#xFC;r unseren Wert nur solange er unver&#xE4;nderlich ist.
Aber wir wollen ja etwas ver&#xE4;ndern, also m&#xFC;ssen wir irgendwie sicherstellen, dass immer nur ein Thread gleichzeitig unseren Wert ver&#xE4;ndern kann.
Sie m&#xFC;ssen sich gegenseitig ausschlie&#xDF;en oder <em>mutually exclude</em> another.</p>
<p>Daf&#xFC;r gibt es den Typ <code>Mutex&lt;T&gt;</code>!
Hier also endlich die funktionierende Variante:</p>
<pre><code class="lang-rust"><span class="hljs-keyword">use</span> std::sync::{Arc, Mutex};
<span class="hljs-keyword">use</span> std::thread;

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    <span class="hljs-keyword">let</span> data = Arc::new(Mutex::new(<span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]));

    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">3</span> {
        <span class="hljs-keyword">let</span> data = data.clone();
        thread::spawn(move || {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> data = data.lock().unwrap();
            data[i] += <span class="hljs-number">1</span>;
        });
    }

    thread::sleep_ms(<span class="hljs-number">50</span>);
}
</code></pre>
<p>Beachte dass der Wert von <code>i</code> in die Closure kopiert wird und nicht zwischen den Threads geteilt wird.
Beachte au&#xDF;erdem, dass <a href="http://doc.rust-lang.org/stable/std/sync/struct.Mutex.html#method.lock" target="_blank"><code>lock</code></a> eine Methode von
<a href="http://doc.rust-lang.org/stable/std/sync/struct.Mutex.html" target="_blank"><code>Mutex</code></a> folgende Signatur hat:</p>
<pre><code class="lang-ignore">fn lock(&amp;self) -&gt; LockResult<mutexguard<t>&gt;
</mutexguard<t></code></pre>
<p>und weil <code>Send</code> f&#xFC;r <code>MutexGuard&lt;T&gt;</code> nicht implementiert ist kann der Guard keine Threadgrenze &#xFC;berschreiten, wodurch Locks nur threadlokal akquiriert und freigegeben werden k&#xF6;nnen.</p>
<p>Schauen wir uns das doch mal genauer an:</p>
<pre><code class="lang-rust"># <span class="hljs-keyword">use</span> std::sync::{Arc, Mutex};
# <span class="hljs-keyword">use</span> std::thread;
# <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
#     <span class="hljs-keyword">let</span> data = Arc::new(Mutex::new(<span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]));
#     <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">3</span> {
#         <span class="hljs-keyword">let</span> data = data.clone();
thread::spawn(move || {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> data = data.lock().unwrap();
    data[i] += <span class="hljs-number">1</span>;
});
#     }
#     thread::sleep_ms(<span class="hljs-number">50</span>);
# }
</code></pre>
<p>Erst rufen wir <code>lock()</code> auf, wodurch wir das Lock auf das Mutex akquirieren.
Weil das fehlschlagen k&#xF6;nnte gibt <code>lock()</code> ein <code>Result&lt;T, E&gt;</code> zur&#xFC;ck.
Das <code>unwrap()</code> ist nur hier im Beispiel angemessen.
Sobald wir das Lock haben d&#xFC;rfen wir endlich den Wert ver&#xE4;ndern.</p>
<p>Zum Schluss warten wir noch mit einem Timer, das ist nicht ideal,
weil wir die Zeit genau absch&#xE4;tzen m&#xFC;ssten.
Besser w&#xE4;re einer der Mechanismen den Rusts Standardbibliothek zum Synchronisieren von Threads bereith&#xE4;lt: Channels.</p>
<h2 id="channels"><a name="channels" class="plugin-anchor" href="#channels"><span class="fa fa-link"></span></a>Channels</h2>
<p>Hier ist eine Variante des obigen Beispiels in der wir Channels zur Synchronisation verwenden, anstatt eine bestimmte Zeit zu warten:</p>
<pre><code class="lang-rust"><span class="hljs-keyword">use</span> std::sync::{Arc, Mutex};
<span class="hljs-keyword">use</span> std::thread;
<span class="hljs-keyword">use</span> std::sync::mpsc;

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    <span class="hljs-keyword">let</span> data = Arc::new(Mutex::new(<span class="hljs-number">0</span>));

    <span class="hljs-keyword">let</span> (tx, rx) = mpsc::channel();

    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">10</span> {
        <span class="hljs-keyword">let</span> (data, tx) = (data.clone(), tx.clone());

        thread::spawn(move || {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> data = data.lock().unwrap();
            *data += <span class="hljs-number">1</span>;

            tx.send(());
        });
    }

    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">10</span> {
        rx.recv();
    }
}
</code></pre>
<p>Wir nutzen die Methode <code>mpsc::channel()</code> um einen Channel zu erzeugen.
Dann <code>send</code>en wir einfach <code>()</code> hindurch und warten darauf bis Zehn davon zur&#xFC;ckgekommen sind.</p>
<p>Dieser Channel sendet zwar nur einfache Signale, aber wir alles was <code>Send</code> implementiert durch den Channel senden!</p>
<pre><code class="lang-rust"><span class="hljs-keyword">use</span> std::thread;
<span class="hljs-keyword">use</span> std::sync::mpsc;

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    <span class="hljs-keyword">let</span> (tx, rx) = mpsc::channel();

    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">10</span> {
        <span class="hljs-keyword">let</span> tx = tx.clone();

        thread::spawn(move || {
            <span class="hljs-keyword">let</span> answer = i * i;

            tx.send(answer);
        });
    }

    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">10</span> {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;{}&quot;</span>, rx.recv().unwrap());
    }
}
</code></pre>
<p>Hier erzeugen wir 10 Threads und lassen jeden das Quadrat einer Zahl berechnen (<code>i</code> zum Zeitpunkt von <code>spawn()</code>) und dann mit <code>send()</code> zur&#xFC;cksenden.</p>
<h2 id="panics"><a name="panics" class="plugin-anchor" href="#panics"><span class="fa fa-link"></span></a>Panics</h2>
<p>Eine <code>panic!</code> crasht den aktuellen Thread, deshalb kann man in Rust Threads als Mechanismus zur Isolation verwenden:</p>
<pre><code class="lang-rust"><span class="hljs-keyword">use</span> std::thread;

<span class="hljs-keyword">let</span> handle = thread::spawn(move || {
    <span class="hljs-built_in">panic!</span>(<span class="hljs-string">&quot;oops!&quot;</span>);
});

<span class="hljs-keyword">let</span> result = handle.join();

<span class="hljs-built_in">assert!</span>(result.is_err());
</code></pre>
<p><code>Thread.join()</code> gibt uns ein <code>Result</code>, welches zeigt, ob der Thread erfolgreich war oder ob eine <code>panic!</code> aufgetreten ist.</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../book/Iteratoren.html" class="navigation navigation-prev " aria-label="Previous page: Iteratoren"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../book/Syntax_Und_Semantik.html" class="navigation navigation-next " aria-label="Next page: Syntax und Semantik"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"anchors":{},"highlight":{},"search":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
